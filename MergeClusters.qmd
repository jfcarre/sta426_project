---
title: "MergeDatasets"
author: "Jose F Carre√±o"
format: html
embed-resources: true
editor: source
editor_options: 
  chunk_output_type: inline
---

### Load necessary libraries

```{r, warning=FALSE, include=FALSE}
library(Seurat)
library(cowplot)
library(ggplot2)
library(dplyr) 
```


### Set important paths

```{r}
dataDirs <- list(
   day60_CD4 = list(
     cellRanger =
"/srv/gstore/projects/p29781/o30306_CellRangerCount_2022-12-20--11-08-02/IEOday60_CD4protocol",
     seuratReport =
"/srv/gstore/projects/p29781/o30306_ScSeurat_2022-12-20--22-03-42/IEOday60_CD4protocol_SCReport",
     labeledObject = NULL
   ), # Not used for now
###############################################################
   day60_ctrl = list(
     cellRanger =
"/srv/gstore/projects/p29781/o30306_CellRangerCount_2022-12-20--11-08-02/IEOday60_controlprotocol",
     seuratReport =
"/srv/gstore/projects/p29781/o30306_ScSeurat_2022-12-20--22-03-42/IEOday60_controlprotocol_SCReport",
     labeledObject =
"/srv/gstore/projects/p29781/additional-analyses/2022-11-28-relabel-day60-o30306/day60_ctrl"
   ), # This is the second run of the ctrl experiment
   day60_otic = list(
     cellRanger =
"/srv/gstore/projects/p29781/o29804_CellRangerCount_2022-11-04--11-20-44/day60oticdiff_Library_418886_1",
     seuratReport =
"/srv/gstore/projects/p29781/o29804_ScSeurat_2022-11-08--10-01-51/day60oticdiff_Library_418886_1_SCReport",
     labeledObject =
"/srv/gstore/projects/p29781/additional-analyses/2022-11-28-relabel-day60"
   ), # This is the dataset contaminated with neurons
###############################################################
   day30 = list(
     cellRanger =
"/srv/gstore/projects/p27889/o29467_CellRangerCount_2022-09-16--09-26-33/day30oticvesicle_Library_412321",
     seuratReport =
"/srv/gstore/projects/p27889/o29467_ScSeurat_2022-09-22--15-04-32/day30oticvesicle_Library_412321_SCReport",
     labeledObject =
"/srv/gstore/projects/p27889/additional-analyses/2022-10-04-relabel-day30oticvesicle"
   ), # Not used for now
   day08 = list(
     cellRanger =
"/srv/gstore/projects/p27889/o28146_CellRangerCount_2022-07-11--09-59-01/placodeday8test1",
     seuratReport =
"/srv/gstore/projects/p27889/o28146_ScSeurat_2022-05-19--11-14-04/placodeday8test1_SCReport",
     labeledObject =
"/srv/gstore/projects/p27889/additional-analyses/2022-08-19-Seurat-relabeled"
   ) # Not used for now
)
dataDirs

resultDir <- "/scratch/jcarreno/sta426_project/results"
```

### Genes of interest

```{r}
reference_genes <- list(
  ghc = c('ATOH1',
'MYO7A',
'MYO6',
'PCP4',
'ANXA4',
'GFI1',
'ESPN',
'TMPRSS3',
'BDNF',
'CCER2',
'GNG8',
'POU4F3',
'OTOF',
'FSIP1',
'ZBBX',
'SKOR1',
'DNAH5',
'SCL26A5',
'GATA3',
'LMOD3',
'FGF8',
'INSM1',
'DNM3'
),
oep = c(
'EPCAM',
'CDH1',
'SOX2',
'SIX1',
'OC90',
'SOX10',
'FBXO2',
'LMX1A',
'PAX2',
'PAX8',
'DLX5',
'GBX2',
'JAG1',
'TBX2',
'COL9A2',
'OTOA',
'MYO5C',
'OTOL1',
'USH1C',
'PCDH9')
)
```

## Analysis {.tabset}

### Merge datasets

#### Load data

First we load the data from the server and we identify the source of each dataset

```{r, eval = FALSE}
day60_otic <- readRDS(file = paste(dataDirs$day60_otic$labeledObject, "/scData.rds",sep = ""))
day60_ctrl <- readRDS(file = paste(dataDirs$day60_ctrl$labeledObject, "/scData.rds",sep = ""))
```


```{r, eval = FALSE}
day60_otic$experiment <- "day60_otic"
day60_ctrl$experiment <- "day60_ctrl"
```


#### Merge the two datasets

Now, we can merge the datasets using FindIntegrationAnchors() and IntegrateData() from Seurat package.

```{r, eval = FALSE}
anchors <- FindIntegrationAnchors(object.list = list(day60_otic, day60_ctrl), dims = 1:20)
```

```{r, eval = FALSE}
combined <- IntegrateData(anchorset = anchors, dims = 1:20)
```

```{r}
#combined <- readRDS(file = "combinedSeurat.rds")
```


### Compute fitness of the merge

#### Dimensionality

We can perform now basic visual inspection to check if the integration has been done properly

```{r}
DefaultAssay(combined) <- "integrated"
```

```{r}
# Run the standard workflow for visualization and clustering
combined <- ScaleData(combined, verbose = FALSE)
combined <- RunPCA(combined, npcs = 30, verbose = FALSE)
ElbowPlot(combined)
```
#### Dimensionality Reduction

```{r}
combined <- RunUMAP(combined, reduction = "pca", dims = 1:20)
combined <- FindNeighbors(combined, reduction = "pca", dims = 1:20, k.param = 9)
combined <- FindClusters(combined, resolution = 0.5)
```


```{r, fig.width=10, fig.height=5}
p1 <- DimPlot(combined, reduction = "umap", group.by = "experiment")
p2 <- DimPlot(combined, reduction = "umap", label = TRUE)
plot_grid(p1, p2)
```


```{r, fig.width=8, fig.height=8}
p1<- DimPlot(combined, reduction = "umap", split.by = "experiment")
p2<- DimPlot(combined, reduction = "umap", group.by = "clusterLabels")
plot_grid(p1, p2, ncol=1)
```

Save the combined data

```{r}
#saveRDS(combined, file = "combinedSeurat.rds")
#combined <- readRDS(file = "combinedSeurat.rds")
DefaultAssay(combined) <- "RNA"
combined <- ScaleData(combined, verbose = FALSE)
```

### Compute Module Scores

```{r}
combined <- AddModuleScore(combined, features=reference_genes, name="module")
```

```{r, fig.width=10, fig.height=5}
featNames <- paste0("module", 1:length(reference_genes))
FeaturePlot(combined, featNames)
```

```{r, fig.width=15, fig.height=8}
VlnPlot(combined, featNames)
VlnPlot(combined, featNames)
```



### Identification of HC

Note: MYO7A is a gene used by Steinhard et al. However, it does not appear in our analysis as it has likely been discarded due to its low presence during QC or during the merging of both datasets.

```{r}
ghc <- c('ATOH1',
'MYO7A',
'MYO6',
'PCP4',
'ANXA4',
'GFI1',
'ESPN',
'TMPRSS3',
'BDNF',
'CCER2',
'GNG8',
'POU4F3',
'OTOF',
'FSIP1',
'ZBBX',
'SKOR1',
'DNAH5',
'SCL26A5',
'GATA3',
'LMOD3',
'FGF8',
'INSM1',
'DNM3'
)
```


```{r}
for (marker in ghc){
  tryCatch({print(FeaturePlot(combined, reduction = "umap", features = marker, order= TRUE))},
           error=function(e){print("ERROR")},
           warning=function(w){print(paste(marker, "not present"))})
}
```

Show subset of clusters (small clusters, those that are likely to be of interest)

```{r, fig.width=15, fig.height=15}
DoHeatmap(combined, features = ghc, cells = WhichCells(combined, idents = c("8","9","10","11","12","13","14","15","16","17","18","19","20")))
```

Number of cells per cluster:

```{r}
cellCountperCluster <- data.frame(id = Idents(combined))
barplot = ggplot(data=cellCountperCluster, aes(x=id)) + 
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  theme_minimal()
barplot + labs(x="Cluster", y = "Cell count")
```

```{r}
DotPlot(combined, features=ghc) + coord_flip() + theme(axis.text.x = element_text(size = 8))     
```

```{r}
for (marker in ghc){
  tryCatch({print(print(VlnPlot(combined, marker)))},
           error=function(e){print("ERROR")},
           warning=function(w){print(paste(marker, "not present"))})
}
```


```{r}
cells.use <- WhichCells(combined, idents = '20')
DimPlot(combined, reduction = "umap", group.by = "ident", cells.highlight = cells.use, sizes.highlight = 0.3) + NoLegend()
```

Cluster 20 is likely to be HC cluster

## Identification of Otic Epithelium

```{r}
oep <- c(
'EPCAM',
'CDH1',
'SOX2',
'SIX1',
'OC90',
'SOX10',
'FBXO2',
'LMX1A',
'PAX2',
'PAX8',
'DLX5',
'GBX2',
'JAG1',
'TBX2',
'COL9A2',
'OTOA',
'MYO5C',
'OTOL1',
'USH1C',
'PCDH9')
```


```{r}
for (marker in oep){
  tryCatch({print(FeaturePlot(combined, reduction = "umap", features = marker, order= TRUE))},
           error=function(e){print("ERROR")},
           warning=function(w){print(paste(marker, "not present"))})
}
```


```{r, fig.width=15, fig.height=15}
DoHeatmap(combined, features = ghc)
```


```{r}
DotPlot(combined, features=oep) + coord_flip() + theme(axis.text.x = element_text(size = 8))  
```

```{r}
for (marker in oep){
  tryCatch({print(VlnPlot(combined, marker))},
           error=function(e){print("ERROR")},
           warning=function(w){print(paste(marker, "not present"))})
}
```


Cluster 13 is likely to be OEP cells

## Reproduce Fig 6. E, H from Steinhart

```{r}
hc_stei <- c(
  "ATOH1",
  "MYO7A",
  "OTOF",
  "STRC",
  "ESPN",
  "GPX2",
  "PCDH15",
  "CDH23",
  "USH2A",
  "POU4F3",
  "CABP2",
  "GFI1",
  "USH1C",
  "RIPOR2",
  "MYO6",
  "MYO15A",
  "CIB2",
  "PCP4",
  "CALM2",
  "LHFPL5"
)
```

```{r}
oep_stei <- c(
  "PAX8",
  "PAX2",
  "OC90",
  "HMX3",
  "DLX3", 
  "DLX5",
  "SALL4",
  "DUSP6",
  "SPRY2",
  "SIX1",
  "EYA1",
  "FOXG1",
  "LMX1A",
  "OTOA",
  "APOE",
  "SMOC2",
  "SPARCL1",
  "FBXO2",
  "COL11A1",
  "COL9A2"
)
```

```{r, fig.width=15, fig.height=15}
VlnPlot(combined, hc_stei, idents = c("20", "13"))
```



```{r, fig.width=15, fig.height=15}
VlnPlot(combined, oep_stei, idents = c("20", "13"))
```

